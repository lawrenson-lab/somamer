---
title: "QC overview. Boring but relevant
"
---

```{r}
library(tidyverse)
library(rstatix)
library(ggrepel)
#read the data
data<-readxl::read_excel("data/227_0001_01_UTHSA_Report.xlsx",sheet = "Proteins")
#the :: operator allows you to use function read_excel from library readxl without loading the library
```

# General overview of the table
```{r}
colnames(data)%>%view()# to see column names in a new tab
dim(data)#to see data size
#dim(data)
#[1] 10457    99
#the 1st number is the row size, the 2nd is the column size

data%>%
  select(SeqID:Gene)%>%#to see from column SeqID to column Gene
  apply(2,function(x) #apply to every column (represented by x) the function in line 27
    #2 means columns, 1 would run over rows
  length(unique(x)))# length of a set with the non duplicated values from column x
#  SeqID Uniprot    Gene 
#  10457    9389    9580 
#SeqID has unique identifiers
```
## Check variables in rows (proteins, genes, whatever is in your table )
```{r}
#recover duplicated protein IDs
duplicated_proteins<-data%>%
  select(SeqID:Gene)%>%
  add_count(Uniprot)%>%#to count how many times each protein appears
  filter(n>1)%>%#to keep non unique proteins
  arrange(Uniprot)#so you can see SeqIDs for the same protein together
  #do the equivalent for genes

#check the distribution of some proteins
data%>%
  filter(Uniprot%in%c("A6NH11","A8K4G0"))%>%#to see only these 2 (duplicated) proteins
  select(SeqID,Gene,Counts_BEME004_Control_Control_NA:Counts_BEME639_Control_Control_NA)%>%
  pivot_longer(Counts_BEME004_Control_Control_NA:Counts_BEME639_Control_Control_NA,
               names_to = "sample",values_to = "raw_values")%>%#reshape the table
               #all Counts_... column names will become the values a column named sample
               #the expression values of Counts_... columns will be in column raw_values
  #try the previous 5 columns first, so you can see the reshaped table
  ggplot(aes(x=raw_values,col=SeqID))+#to plot with raw_values in x axis and 1 color per unique identifier
  geom_density()+# to see expression distribution, y axis will be the frequency of values in x axis
  facet_grid(rows=vars(Gene))#to have a plot per Gene, order by rows
#try chaging geom_density with geom_histogram
#do you think seq.10713.151 is expressed?
#what about seq.29496.20?

#check the average value for all probes
temp<-data%>%
  select(SeqID,Gene,Counts_BEME004_Control_Control_NA:Counts_BEME639_Control_Control_NA)%>%
  pivot_longer(Counts_BEME004_Control_Control_NA:Counts_BEME639_Control_Control_NA,
               names_to = "sample",values_to = "raw_values")%>%
  group_by(SeqID)%>%summarise(avg=mean(raw_values))#to get the mean of raw_values for every group
# plot
temp%>%
  ggplot(aes(x=0,y=avg))+#arbitrary x
  geom_boxplot()+
  geom_text_repel(data=temp%>%slice_min(avg,n=3),#to get the 3 probes with the lowest average
                  aes(x=0,y=avg,label=SeqID))+#to label boxplot points
  scale_y_log10()#so y axis in log10 scale
#do you think seq.10024.44 is expressed?
#try labeling the top probes

```

## PCA
```{r}
mat<-data%>%select(Counts_BEME004_Control_Control_NA:
                     Counts_Test00005_Endometriosis_NA_NA)
#to have duplicated gene names
rownames(mat)<-make.names(data$Gene,unique = 1)
#adds X at the beginning of gene names that start with number
#adds .1,.2,... at the end of duplicated genes

pcares<-mat%>%
  log()%>%#log transform the data to stabilize the variance
  t()%>%#transpose the matrix
  prcomp(scale. = T)#pca
temp<-pcares$x%>%as.data.frame()#to get the coordinates of the samples in the dimension reduced space

#there are as many components as samples
ncol(mat)==ncol(temp)
#for elbow plot
data.frame(var_percent=100*pcares$sdev**2/sum(pcares$sdev**2),
           pc=1:length(pcares$sdev))%>%
  ggplot(aes(x=pc,y=var_percent))+geom_col()
#you need 15 components to explain 50% of data variances

temp<-temp%>%
  rownames_to_column("sample")%>%#opposite to column_to_rownames
  mutate(type=str_split_i(sample,pattern = "_",i = 3))#create a new column named type by splitting sample names at every "_" an keeping the 3rd value 
temp%>%ggplot(aes(x=PC1,y=PC2,col=type))+#to color by the new type column
  geom_point()+#for scatterplot
  geom_text_repel(data=temp%>%slice_min(PC2,n = 3),
                  aes(x=PC1,y=PC2,label=sample))+
  geom_text_repel(data=temp%>%slice_min(PC1,n = 3),
                  aes(x=PC1,y=PC2,label=sample))
#spot the outlier

#you can check if any of the PCs separates the groups
testres<-temp%>%
  pivot_longer(PC1:PC85,names_to = "comp",values_to = "variate")%>%
  group_by(comp)%>%
  wilcox_test(variate~type)
testres%>%filter(p.adj<0.05)

#lack of clustering indicates too much noisy proteins
i<-which(abs(data$Log2FC_LApos.LAneg)>=1)
pcares<-mat[i,]%>%
    log()%>%#log transform the data to stabilize the variance
    t()%>%#transpose the matrix
    prcomp(scale. = T)#pca
temp<-pcares$x%>%as.data.frame()
temp%>%
    rownames_to_column("sample")%>%#opposite to column_to_rownames
    mutate(type=str_split_i(sample,pattern = "_",i = 3))%>%
    ggplot(aes(x=PC1,y=PC2,col=type))+#to color by the new type column
    geom_point()
```
# Check expression by sample
```{r}
summary(mat)#statistics about value distribution for the sample

#like summary but visual
temp<-temp%>%rownames_to_column("SeqID")%>%
  pivot_longer(-1,names_to = "sample",values_to = "raw_value")
temp%>%ggplot(aes(x=sample,y=raw_value))+
  geom_boxplot()+
  scale_y_log10()+
  theme(axis.text.x = element_text(angle=45,vjust = 1,hjust = 1))#otherwise samplenames will be horizontal and unreadable
#samples with really different distributions may be a red flag

#you can check distributions are not significantly different but this is slow
#run it for some samples
temp%>%
  wilcox_test(raw_value~sample,#test expression by sample
              ref.group ="Counts_BEME025_Endometrioma_Endometrioma_NA")#arbitrary reference
#there are better test for this, what did they used for the report?
```
# top genes per contrast
```{r}
#to check the changes betwtween conditions
temp<-data%>%select(Gene,Log2FC_LApos.LAneg,
              Log2FC_Endometrioma.Control,
              Log2FC_Endometriosis.Control,
              Log2FC_EDTA.CPT)
temp%>%select(-1)%>%summary()#numeric result
temp<-temp%>%pivot_longer(-1,names_to = "contrast",values_to = "LFC")
#visual result (same idea than volcano, more space efficient, can show shared genes)
temp%>%ggplot(aes(x=contrast,y=LFC))+geom_boxplot()+
  geom_text_repel(data = temp%>%group_by(contrast)%>%slice_max(abs(LFC),n=10),
              #label top 10 altered genes
                  aes(x=contrast,y=LFC,label=Gene))

# check expression distribution for some genes
temp<-data%>%filter(Gene%in%c("CRDL2","SAA"))%>%
  select(SeqID,Gene,Counts_BEME004_Control_Control_NA:Counts_Test00005_Endometriosis_NA_NA)%>%
  pivot_longer(-1,names_to = "sample",values_to = "expr")%>%
  mutate(sampletype=str_split_i(sample,pattern = "_",i = 3),
         Gene=paste0(Gene,":",SeqID))
temp%>%
  ggplot(aes(x=sampletype,y=expr))+geom_violin()+geom_boxplot(width=.1)+
  scale_y_log10()+facet_grid(~Gene)+
  theme(axis.text.x = element_text(angle=45,vjust = 1,hjust = 1))+
  stat_compare_means(label = "p.signif",
                     comparisons = list(c("Control","Endometrioma"),
                                        c("Control","Endometriosis"),
                                        c("Control","EndometriosisLAneg"),
                                        c("Control","EndometriosisLApos")))
temp%>%distinct(sample,sampletype)%>%count(sampletype)
```

# Does enrichment make sense with this type of data?
```{r}
temp<-data%>%select(Gene,Log2FC_EDTA.CPT,Log2FC_Endometriosis.Control,
                    Log2FC_Endometrioma.Control,Log2FC_LApos.LAneg)%>%
  pivot_longer(-1,names_to = "contrast",values_to = "LFC")
ranks<-temp%>%split(f = temp$contast)%>%lapply(function(x) 
  x%>%drop_na()%>%group_by(Gene)%>%slice_max(LFC)%>%arrange(desc(LFC))%>%
    select(-contast)%>%deframe)

#find appropiate db for this ids
gseares<-lapply(ranks,function(x) 
  gseGO(geneList = x,keyType = "SYMBOL",ont="BP",OrgDb = 'org.Hs.eg.db'))
sapply(gseares,nrow)
```